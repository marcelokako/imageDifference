name: Pipeline Github Actions

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Compilar o código Java
        run: javac *.java

      - name: Listar arquivos compilados
        run: ls -l *.class

  sast:
    name: SAST
    needs: build
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Configurar Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Compilar o código Java (para análise do CodeQL)
        run: javac *.java

      - name: Executar análise do CodeQL
        uses: github/codeql-action/analyze@v3

  test:
    name: Teste de Arquivos
    needs: sast
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Verificar se imagens existem
        run: |
          test -f exemplo.png || (echo "Erro: Arquivo 'exemplo.png' não encontrado!" && exit 1)
          test -f exemplo_VAR.png || (echo "Erro: Arquivo 'exemplo_VAR.png' não encontrado!" && exit 1)
          echo "✓ Imagens encontradas."

  dast:
    name: DAST
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Executar OWASP Dependency Check
        uses: owasp/dependency-check-action@v5
        with:
          scanPath: '.' # Escaneia o diretório raiz
          format: 'HTML'
          # Descomente abaixo para falhar o build se uma CVE de score 8+ for achada
          # failOnCvss: 8 

      - name: Upload do Relatório de Dependências
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: 'reports/dependency-check-report.html'
          if-no-files-found: warn # Não falhar se o relatório não for gerado
